# 执行上下文和调用栈

## 执行上下文是什么

### 执行上下文的分类

执行上下文主要分三类

- 全局上下文 -> 全局代码所处的环境,不在函数中的代码都在全局上下文中
- 函数上下文 -> 在函数调用时创建的上下文
- Eval 执行上下文 -> 运行 Eval 函数中的代码时所创建的环境

### 执行上下文的声明周期

#### 创建阶段

- this 绑定
  - 全局上下文
    - this 指向全局对象(浏览器中是 window)
  - 函数上下文
    - this 的值取决于该函数如何被调用
      - 被对象调用
        - this -> 调用的对象
      - 否则
        - this -> 全局对象
        - this -> undefined(严格模式)
- 词法环境
  - 定义:一种持有标识符->变量 映射的解构
    - 标识符
      - 变量/函数的名字
    - 变量
      - 对实际对象或原始数据的引用
  - 两个组件
    - 环境记录器
      - 作用:存储变量和函数声明的实际位置
      - 类型
        - 声明式环境记录器(函数环境)
          - 存储变量. 函数和参数
            - 同名情况下 函数优先级 > 变量
          - 变量
            - 变量名:value
              - let 创建的为 未初始化
              - var 创建的为 undefined
          - 函数
            - reference to functionName(){}
          - arguments 对象
            - 存储方式
              - index:value 的形式
            - 参数 length
        - 对象环境记录器(全局环境)
          - 出现在全局上下文中的变量和函数的关系
    - 外部环境的引用
      - 可以访问父级语法环境
  - 两种类型
    - 全局环境
      - 外部引用
        - null
      - this 指向全局对象
    - 函数环境
      - 内部变量
        - 储存在环境记录器
  - 储存 let 和 const
    - 创建阶段 为未初始化
- 变量环境
  - 也是词法环境
  - 与词法环境的区别
    - 变量环境 储存 var 变量
    - 词法环境 储存 let 和 const
  - var 定义的变量 输出值为 undefined
- 函数(诞生时 创建)
  - 所有函数都有名为[[Environment]]的隐藏属性
    - 该属性保存了对创建函数词法环境的引用

#### 执行阶段

完成对所有变量的分配,最后执行代码

### 栈与堆

- 栈内存
  - 基本类型
    - 固定大小空间
- 堆内存
  - 引用类型
    - 大小不固定
  - 引用访问
    - 从栈中读取内存地址
      - 通过地址找到堆中的值

### VO/AO

- VO 变量对象
  - 是在规范上或者 JS 引擎中实现的, 并不能在 JS 环境中直接访问
- AO 活动对象
  - 进入执行上下文 变量对象被激活
    - 各个属性才能被访问

### 实例

```js
function testA() {
  console.log("执行第一个测试函数逻辑");
  testB();
  console.log("再次执行第一个测试函数逻辑");
}
function testB() {
  console.log("执行第二个测试函数逻辑");
}
testA();
```

运行过程

1. 创建全局上下文
2. 执行到 testA 调用处,创建 testA 对应的函数上下文
3. 执行到 testB 调用处,创建 testB 对应的函数上下文
4. testB 执行完毕, 对应上下文出栈, 剩余 testA 上下文,和全局上下文
5. testA 执行完毕, 对应上下文出栈, 剩余全局上下文
6. 所有代码执行完毕, 引擎会移除全局上下文
